name: Test example positive
on:
#  # Uncomment when test added first time to register workflow and comment it back after workflow would be registered
#  #
#  # Added pull_request to register workflow from the PR.
#  # Read more https://stackoverflow.com/questions/63362126/github-actions-how-to-run-a-workflow-created-on-a-non-master-branch-from-the-wo
  pull_request: {}
  workflow_dispatch: {}

jobs:
#  setup:
#    runs-on: ubuntu-latest
#    steps:
#      - name: Setup
#        run: echo "Do setup"

  test:
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      matrix: 
        flavor: ['pr-number', 'branch-name', 'custom']
        app-name: ['namespace-builder']
        prefix: ['cp']
        suffix: ['']
        deny-list: ['', 'kube-system,kube-public,default', '']
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - uses: ./
        id: current
        with:
          flavor: ${{ matrix.flavor }}
          app-name: ${{ matrix.app-name }}
          prefix: ${{ matrix.prefix }}
          name: ${{ matrix.flavor == 'custom' && 'custom-name' || '' }}
          suffix: ${{ matrix.suffix }}
          deny-list: ${{ matrix.deny-list }}

      - uses: cloudposse/github-action-matrix-outputs-write@0.3.1
        id: out
        with:
          matrix-step-name: test
          matrix-key: ${{ matrix.flavor }}
          outputs: |-
            result: ${{ steps.current.outputs.kubernetes-namespace }}
  
  read:
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - uses: cloudposse/github-action-matrix-outputs-read@main
        id: read
        with:
          matrix-step-name: test

    outputs:
      result: "${{ steps.read.outputs.result }}"
      
  assert:
    runs-on: ubuntu-latest
    needs: [read]
    steps:
      - run: echo "DEBUG " ${{ fromJson(needs.read.outputs.result) }}
      - run: echo "PR namespace " ${{ fromJson(needs.read.outputs.result).result.pr-number }}
      - run: echo "Branch namespace " ${{ fromJson(needs.read.outputs.result).result.branch-name }}
      - run: echo "Custom namespace " ${{ fromJson(needs.read.outputs.result).result.custom }}
      
      - uses: nick-fields/assert-action@v1
        with:
          expected: 'true'
          actual: "${{ needs.test.outputs.result }}"

  teardown:
    runs-on: ubuntu-latest
    needs: [assert]
    if: ${{ always() }}
    steps:
      - name: Tear down
        run: echo "Do Tear down"
