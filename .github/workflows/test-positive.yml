name: Test example positive
on:
#  # Uncomment when test added first time to register workflow and comment it back after workflow would be registered
#  #
#  # Added pull_request to register workflow from the PR.
#  # Read more https://stackoverflow.com/questions/63362126/github-actions-how-to-run-a-workflow-created-on-a-non-master-branch-from-the-wo
  pull_request: {}
  workflow_dispatch: {}

jobs:
#  setup:
#    runs-on: ubuntu-latest
#    steps:
#      - name: Setup
#        run: echo "Do setup"

  test:
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      matrix: 
        flavor: ['pr-number', 'branch-name', 'custom']
        app-name: ['namespace-builder']
        prefix: ['cp']
        suffix: ['']
        deny-list: ['', 'kube-system,kube-public,default']
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - uses: ./
        name: Test PR Number
        id: pr-number
        with:
          flavor: pr-number
          app-name: app
          prefix: cp
          suffix: suffix
          deny-list: kube-system,kube-public,default

      - run: echo "Current namespace '${{ steps.current.outputs.kubernetes-namespace }}'"
      - uses: nick-fields/assert-action@v1
        with:
          expected: 'cp-app-pr-'
          comparison: startsWith
          actual: "${{ steps.current.outputs.kubernetes-namespace }}"
      - uses: nick-fields/assert-action@v1
        with:
          expected: '-suffix'
          comparison: endsWith
          actual: "${{ steps.current.outputs.kubernetes-namespace }}"
          
      - uses: ./
        name: Test branch name
        id: pr-number
        with:
          flavor: branch-name
          app-name: app
          prefix: cp
          suffix: suffix
          deny-list: kube-system,kube-public,default

      - run: echo "Current namespace '${{ steps.current.outputs.kubernetes-namespace }}'"
      - uses: nick-fields/assert-action@v1
        with:
          expected: 'cp-app-pr-${{ github.head_ref }}'
          actual: "${{ steps.current.outputs.kubernetes-namespace }}"
          
      - uses: ./
        name: Test custom name
        id: pr-number
        with:
          flavor: custom
          app-name: app
          name: foo
          prefix: cp
          suffix: suffix
          deny-list: kube-system,kube-public,default

      - uses: nick-fields/assert-action@v1
        with:
          expected: 'cp-app-foo-suffix'
          actual: "${{ steps.current.outputs.kubernetes-namespace }}"
          
  teardown:
    runs-on: ubuntu-latest
    needs: [assert]
    if: ${{ always() }}
    steps:
      - name: Tear down
        run: echo "Do Tear down"
